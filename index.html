import React, { useState, useEffect, useRef } from 'react';
import { Peer } from 'peerjs';
import io from 'socket.io-client';

// اتصال السيرفر للدردشة
const socket = io('https://your-backend-server.com');

const DiscordClone = () => {
  const [messages, setMessages] = useState([]);
  const [input, setInput] = useState('');
  const [myId, setMyId] = useState('');
  const [friendId, setFriendId] = useState('');
  const remoteVideoRef = useRef();
  const localVideoRef = useRef();
  const peerInstance = useRef(null);

  useEffect(() => {
    const peer = new Peer();

    peer.on('open', (id) => {
      setMyId(id);
    });

    // استقبال مكالمة فيديو
    peer.on('call', (call) => {
      navigator.mediaDevices.getUserMedia({ video: true, audio: true }).then((stream) => {
        localVideoRef.current.srcObject = stream;
        call.answer(stream);
        call.on('stream', (remoteStream) => {
          remoteVideoRef.current.srcObject = remoteStream;
        });
      });
    });

    peerInstance.current = peer;

    // استقبال رسائل الشات
    socket.on('message', (msg) => {
      setMessages((prev) => [...prev, msg]);
    });
  }, []);

  const startCall = (id) => {
    navigator.mediaDevices.getUserMedia({ video: true, audio: true }).then((stream) => {
      localVideoRef.current.srcObject = stream;
      const call = peerInstance.current.call(id, stream);
      call.on('stream', (remoteStream) => {
        remoteVideoRef.current.srcObject = remoteStream;
      });
    });
  };

  const sendMessage = () => {
    socket.emit('message', input);
    setMessages((prev) => [...prev, { text: input, self: true }]);
    setInput('');
  };

  return (
    <div className="flex h-screen bg-[#36393f] text-gray-100 overflow-hidden">
      {/* 1. قائمة السيرفرات الجانبية */}
      <div className="w-20 bg-[#202225] flex flex-col items-center py-4 space-y-4">
        <div className="w-12 h-12 bg-[#5865f2] rounded-2xl flex items-center justify-center cursor-pointer hover:rounded-xl transition-all">
          <span>D</span>
        </div>
        <div className="w-10 h-[2px] bg-[#36393f]"></div>
        <div className="w-12 h-12 bg-[#36393f] rounded-full hover:bg-[#3ba55d] transition-colors cursor-pointer"></div>
      </div>

      {/* 2. قائمة القنوات */}
      <div className="w-60 bg-[#2f3136] flex flex-col">
        <div className="h-12 shadow-md flex items-center px-4 font-bold border-b border-[#26272b]">
          My Server
        </div>
        <div className="flex-1 p-4 space-y-2">
          <div className="text-gray-400 uppercase text-xs font-bold">Text Channels</div>
          <div className="bg-[#393c43] p-2 rounded text-white cursor-pointer"># general</div>
          <div className="p-2 hover:bg-[#393c43] rounded cursor-pointer text-gray-400"># gaming</div>
        </div>
        <div className="bg-[#292b2f] p-4 flex items-center space-x-2">
          <div className="w-8 h-8 bg-orange-500 rounded-full"></div>
          <div className="text-sm font-bold">User #{myId.slice(0,4)}</div>
        </div>
      </div>

      {/* 3. منطقة الدردشة والفيديو الرئيسية */}
      <div className="flex-1 flex flex-col bg-[#36393f]">
        {/* منطقة الفيديو */}
        <div className="grid grid-cols-2 gap-4 p-4 bg-[#202225]">
          <div className="relative">
             <video ref={localVideoRef} autoPlay muted className="w-full rounded-lg bg-black border-2 border-blue-500" />
             <span className="absolute bottom-2 left-2 bg-black bg-opacity-50 p-1 text-xs">You</span>
          </div>
          <div className="relative">
             <video ref={remoteVideoRef} autoPlay className="w-full rounded-lg bg-black border-2 border-green-500" />
             <span className="absolute bottom-2 left-2 bg-black bg-opacity-50 p-1 text-xs">Friend</span>
          </div>
        </div>

        {/* الرسائل */}
        <div className="flex-1 overflow-y-auto p-6 space-y-4">
          {messages.map((msg, idx) => (
            <div key={idx} className={`flex ${msg.self ? 'justify-end' : 'justify-start'}`}>
              <div className="bg-[#40444b] px-4 py-2 rounded-lg max-w-md">
                {msg.text}
              </div>
            </div>
          ))}
        </div>

        {/* صندوق الإدخال */}
        <div className="p-4 bg-[#36393f]">
          <div className="flex items-center bg-[#40444b] rounded-lg px-4">
            <input 
              value={input}
              onChange={(e) => setInput(e.target.value)}
              placeholder="Message #general" 
              className="w-full bg-transparent py-3 focus:outline-none"
            />
            <button onClick={sendMessage} className="text-[#5865f2] font-bold">SEND</button>
          </div>
        </div>
      </div>

      {/* 4. لوحة التحكم بالاتصال */}
      <div className="w-64 bg-[#2f3136] p-4 border-l border-[#26272b]">
          <h3 className="font-bold mb-4">اتصال فيديو</h3>
          <input 
            className="w-full bg-[#202225] p-2 rounded mb-2 text-sm"
            placeholder="Friend ID"
            value={friendId}
            onChange={(e) => setFriendId(e.target.value)}
          />
          <button 
            onClick={() => startCall(friendId)}
            className="w-full bg-[#3ba55d] p-2 rounded font-bold hover:bg-[#2d7d44]"
          >
            اتصال
          </button>
      </div>
    </div>
  );
};

export default DiscordClone;
